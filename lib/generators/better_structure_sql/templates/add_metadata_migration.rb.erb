class AddMetadataToBetterStructureSqlSchemaVersions < ActiveRecord::Migration<%= migration_version %>
  def up
    # Add new columns
    add_column :better_structure_sql_schema_versions, :content_size, :bigint
    add_column :better_structure_sql_schema_versions, :line_count, :integer

    # Backfill existing records
    BetterStructureSql::SchemaVersion.reset_column_information
    BetterStructureSql::SchemaVersion.find_each do |version|
      version.update_columns(
        content_size: version.content.bytesize,
        line_count: version.content.lines.count
      )
    end

    # Make columns non-nullable
    change_column_null :better_structure_sql_schema_versions, :content_size, false
    change_column_null :better_structure_sql_schema_versions, :line_count, false
  end

  def down
    remove_column :better_structure_sql_schema_versions, :line_count
    remove_column :better_structure_sql_schema_versions, :content_size
  end
end
